<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investeringsprognose</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for the graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom Font Definitions - Bruker må sørge for at disse er lastet inn/tilgjengelige */
        /* Eksempel på @font-face hvis fonter er selv-hostet.
            Du må erstatte 'sti/til/' med den faktiske stien til fontfilene dine.
        @font-face {
            font-family: 'Whitney Bold';
            src: url('sti/til/Whitney-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }
        @font-family: 'Whitney Light';
        src: url('sti/til/Whitney-Light.woff2') format('woff2');
        font-weight: 300;
        font-style: normal;
        }
        @font-face {
            font-family: 'Whitney Medium';
            src: url('sti/til/Whitney-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
        }
        */

        /* CSS Variabler for Fargekoder (Standardisert) */
        :root {
            /* Primære Farger basert på den mørke bakgrunnen i bildet */
            --primary-bg-dark: #1A2A47; /* Den generelle mørke bakgrunnen */
            --card-bg-dark: #24385B; /* Bakgrunn for kortene i bildet */
            
            /* Farger fra bildet for diagrammet */
            --chart-hovedstol: #4ADE80; /* Grønn for Hovedstol */
            --chart-avkastning: #93C5FD; /* Lys Blå for Avkastning */
            --chart-sparing: #3B82F6; /* Mørk Blå for Årlig sparing */
            --chart-netto-utbetaling: #9CA3AF; /* Grå for Netto Utbetaling */
            --chart-skatt: #CD5C5C; /* Lys rød for Skatt (India Red) - for kontrast */
            --chart-event-uttak: #FF6347; /* Tomato Red for Event Withdrawals */


            /* Tilpassede farger for UI elementer basert på bildet */
            --slider-track-color: #364A6E; /* Mørkere spor for sliders */
            --slider-thumb-color: #60A5FA; /* Lys blå for slider-thumb */
            --input-border-color: #475569; /* Border for inputfelter */
            --button-primary-bg: #00A9E0; /* Cyan-lignende for knapper */
            --button-hover-bg: #008CB8; /* Mørkere cyan for hover */

            /* Spesifikke tekstfarger - REN HVIT OVERALT */
            --text-heading: #FFFFFF; /* For H1, H2, H3 */
            --text-general: #FFFFFF; /* Generell tekst, paragrafer, etc. */
            --text-label: #FFFFFF; /* Alle labels */
            --text-value-display: #FFFFFF; /* Verdier ved siden av slidere */
            --text-button-on-blue: #FFFFFF; /* Knappetekst på blå bakgrunn */
            --text-axis: #FFFFFF; /* Aksetekst (år, MNOK) i grafen */
            --text-tooltip: #FFFFFF; /* Tekst i tooltips */

            /* Button colors - used for stock allocation buttons AND tapering options */
            --button-default-bg: #002072; /* Dark Blue from primary colors */
            --button-selected-bg: #00A9E0; /* Cyan-lignende for valgt knapp */
        }

        /* --- Generelle Stiler --- */
        body {
            font-family: 'Whitney Light', sans-serif; /* Standard font for brødtekst */
            background-color: var(--primary-bg-dark); /* Mørk bakgrunn fra bildet */
            color: var(--text-general);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Justert for å unngå vertikal rulling ved for mye innhold */
            min-height: 100vh; /* Sikrer at siden fyller hele viewport høyden */
            margin: 0;
            overflow: hidden; /* Forhindrer rulling */
            padding: 2rem; /* Polstring rundt hovedinnholdet */
            box-sizing: border-box; /* Inkluder polstring i elementets totalbredde/høyde */
        }

        /* Font Stiler basert på spesifikasjoner */
        h1 {
            font-family: 'Whitney Bold', sans-serif;
            font-size: 50pt; /* REDUSERT FRA 60PT TIL 50PT */
            color: var(--text-heading);
            line-height: 1.1;
        }
        h2 {
            font-family: 'Whitney Bold', sans-serif;
            font-size: 30pt;
            color: var(--text-heading);
        }
        h3 {
            font-family: 'Whitney Bold', sans-serif;
            font-size: 16pt; /* Samme som paragrafstørrelse */
            color: var(--text-heading);
        }
        p {
            font-family: 'Whitney Light', sans-serif;
            font-size: 16pt;
            color: var(--text-general);
        }
        label {
            font-family: 'Whitney Medium', sans-serif;
            font-size: 15pt;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-label);
        }
        .quote { /* Ikke brukt i layouten, men definert for fullstendighet */
            font-family: 'Whitney Medium', sans-serif;
            font-size: 30pt;
            font-style: italic;
        }

        /* Overstyrer standard styling for input og knapper for å matche fonten */
        input, button, select, textarea {
            font-family: 'Whitney Light', sans-serif;
            color: var(--text-general);
        }

        /* Responsiv fontstørrelse for mindre skjermer */
        @media (max-width: 1280px) { /* Tilpasning for bærbare skjermer */
            h1 { font-size: 40pt; } /* Justert responsiv størrelse */
            h2 { font-size: 24pt; }
            p, h3 { font-size: 14pt; }
            label { font-size: 12pt; }
            .quote { font-size: 24pt; }
        }
        @media (max-width: 768px) { /* Tilpasning for nettbrett/mobil */
            h1 { font-size: 32pt; } /* Justert responsiv størrelse */
            h2 { font-size: 20pt; }
            p, h3 { font-size: 12pt; }
            color: var(--text-label);
        }

        /* Hovedbeholder for dashboardet */
        .dashboard-container {
            border-radius: 1rem;
            padding: 0; /* Fjern padding her da kortene har egen padding */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1840px; /* ØKT MED 20% FRA 1536PX for å fylle skjermen mer */
            height: 100%;
            max-height: 800px; /* Effektiv oppløsningshøyde */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            box-sizing: border-box;
        }

        /* Bakgrunn for kort-lignende seksjoner */
        .card-bg {
            background-color: var(--card-bg-dark); /* Kortbakgrunn fra bildet */
            border-radius: 0.75rem; /* Avrundede hjørner */
            padding: 1.5rem;
            color: var(--text-general);
        }
        .card-bg h1, .card-bg h2, .card-bg h3 {
            color: var(--text-heading);
        }
        .card-bg label {
            color: var(--text-label);
            font-size: 10pt; /* Mindre størrelse for labels for bedre passform */
        }
        .card-bg .value-display {
            color: var(--text-value-display); /* Farge på verdier ved siden av sliders */
            font-family: 'Whitney Medium', sans-serif;
            font-size: 1rem;
        }

        /* Stylinger for range inputs (sliders) */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            transition: background 0.3s, opacity 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--slider-thumb-color); /* Lys blå farge for glider */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-dark); /* Kantfarge for glider */
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--slider-thumb-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-dark);
        }
        /* Sliders inside card-bg */
        .card-bg input[type="range"] {
            background: var(--slider-track-color); /* Mørkere spor for sliders */
        }

        /* Spesifikk styling for årlig aksjeandel inputs (sliders) - DISSE ER NÅ FJERNES FRA UI */
        #annual-stock-percentage-inputs {
            display: none; /* Skjuler hele seksjonen med individuelle aksjeandel-slidere */
        }

        /* Diagram spesifikk styling */
        canvas {
            background-color: var(--primary-bg-dark); /* Mørk bakgrunn for diagrammet som i bildet */
            border-radius: 0.75rem;
            flex-grow: 1; /* Lats diagrammet fylle tilgjengelig plass */
            max-height: 50vh; /* Begrenser høyden for å unngå rulling */
        }

        /* Overstyrer Chart.js tooltips for å matche temaet */
        .chartjs-tooltip {
            background-color: var(--card-bg-dark) !important;
            color: var(--text-tooltip) !important; /* Matcher bildet */
            border-radius: 0.5rem !important;
            padding: 12px !important;
            font-family: 'Whitney Light', sans-serif !important;
        }
        .chartjs-tooltip-header {
            font-family: 'Whitney Medium', sans-serif !important;
            color: var(--text-tooltip) !important; /* Matcher bildet */
            padding-bottom: 5px !important;
        }
        .chartjs-tooltip-body {
            font-size: 14px !important;
        }

        /* Legend styling */
        #legend-container span {
            color: var(--text-general); /* Hvit tekst for legend på mørk bakgrunn, matcher bildet */
            font-family: 'Whitney Light', sans-serif;
            font-size: 16pt; /* Match paragraph size */
        }
        #legend-container .w-4.h-4 {
            border-radius: 0.25rem; /* Små avrundede firkanter for legend fargeindikator */
        }
        /* Chart.js Y-axis labels styling (og X-akse) */
        .chartjs-render-monitor text {
            fill: #FFFFFF !important; /* Sett til ren hvit for akser og årstall */
            color: #FFFFFF !important; /* Fallback for eldre nettlesere/eksplisitt override */
        }

        /* Sikrer responsivitet for hovedoppsettet */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr; /* Standard: en kolonne */
            gap: 1.5rem;
            flex-grow: 1; /* Takes up available vertical space */
        }
        @media (min-width: 1280px) { /* At 1280px width (xl breakpoint for Tailwind) */
            .grid-container {
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
            }
        }
        /* Styling for Legg til hendelse button */
        .add-event-button {
            background-color: var(--button-primary-bg); /* Blue from image */
            color: var(--text-button-on-blue); /* Button text color, matches image */
            font-family: 'Whitney Medium', sans-serif;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .add-event-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        /* Styling for remove event button */
        .remove-event-button {
            color: var(--text-light-blue); /* Light blue for delete icon */
            transition: color 0.2s ease-in-out;
        }
        .remove-event-button:hover {
            color: #ef4444; /* Red on hover */
        }

        /* Event Row Styling */
        .event-row {
            background-color: rgba(0,0,0,0.2); /* Darker background for event rows */
            border: 1px solid var(--input-border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: var(--text-general);
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.75rem;
            align-items: center;
        }
        .event-row input[type="text"], .event-row input[type="number"] {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid var(--input-border-color);
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
        }
        .event-row label {
            font-size: 0.8rem;
            color: var(--text-label);
        }
        /* Adjusted positioning for range slider labels (start/end year) */
        .event-range-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            /* Adjusted margin-top to push labels further down relative to slider */
            margin-top: 1rem; /* Reduced from 1.5rem to 1rem based on visual check */
            color: var(--text-general); /* Explicitly white for these labels */
        }

        .event-range-slider-container {
            position: relative;
            /* Reduced height to reduce overall vertical space, ensuring labels still fit */
            height: 35px; /* Reduced from 40px to 35px */
        }

        .event-range-slider-start,
        .event-range-slider-end {
            height: 5px; /* Visual track height */
            background: transparent; /* Make default track transparent to use custom highlight */
            position: absolute;
            width: 100%;
            pointer-events: auto; /* Ensure sliders are interactive */
            top: 5px; /* Adjusted top to position track correctly within new height */
            margin: 0; /* Remove default margins */
        }

        /* Custom track style */
        .event-range-track {
            position: absolute;
            top: 5px; /* Match slider top position */
            transform: translateY(0); /* Remove transform */
            width: 100%;
            height: 4px;
            background-color: var(--slider-track-color);
            border-radius: 2px;
            pointer-events: none;
        }
        .event-range-highlight {
            position: absolute;
            top: 5px; /* Match slider top position */
            transform: translateY(0); /* Remove transform */
            height: 4px;
            background-color: var(--slider-thumb-color);
            border-radius: 2px;
            pointer-events: none;
        }

        .event-range-slider-start::-webkit-slider-thumb,
        .event-range-slider-end::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--slider-thumb-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-dark);
            margin-top: -6px; /* Adjust thumb position to align with track */
        }
        .event-range-slider-start::-moz-range-thumb,
        .event-range-slider-end::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--slider-thumb-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-dark);
            margin-top: -6px; /* Adjust thumb position to align with track */
        }


        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-container input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--slider-track-color);
            border-radius: 0.25rem;
            background-color: rgba(0,0,0,0.3);
            cursor: pointer;
            position: relative;
            outline: none;
        }

        .checkbox-container input[type="checkbox"]:checked {
            background-color: var(--button-primary-bg); /* Filled when checked */
            border-color: var(--button-primary-bg);
        }

        .checkbox-container input[type="checkbox"]:checked::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0.5rem;
            height: 0.8rem;
            border-right: 2px solid var(--text-button-on-blue); /* Matcher knappetekstfarge */
            border-bottom: 2px solid var(--text-button-on-blue); /* Matcher knappetekstfarge */
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .checkbox-container label {
            margin-bottom: 0; /* Remove default margin for label */
            color: var(--text-label);
        }
        /* Speedometer specific styles - removed as per user request for buttons */
        .speedometer-container {
            display: none; /* Hide speedometer container */
        }
        /* Icon styling within speedometer segments - removed as per new design */
        .speedometer-svg .icon-text {
            display: none; /* Hide icons as per new design */
        }

        /* Button styles for stock allocation */
        .stock-allocation-button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Responsive columns */
            gap: 0.5rem; /* Gap between buttons */
            width: 100%;
        }

        .stock-allocation-button {
            aspect-ratio: 1 / 1; /* Make buttons square */
            background-color: var(--button-default-bg);
            color: var(--text-button-on-blue);
            font-family: 'Whitney Medium', sans-serif;
            font-size: 0.9rem; /* Adjust font size to fit */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            padding: 0.25rem; /* Small padding */
        }

        .stock-allocation-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }

        .stock-allocation-button.selected {
            background-color: var(--button-selected-bg);
            box-shadow: 0 0 8px var(--button-selected-bg); /* Highlight selected button */
        }

        /* New Tapering option box styles */
        .tapering-option-box {
            background-color: var(--button-default-bg);
            color: var(--text-button-on-blue);
            font-family: 'Whitney Medium', sans-serif;
            font-size: 0.9rem;
            border-radius: 0.5rem;
            padding: 0.75rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, border-color 0.2s ease-in-out;
            border: 2px solid transparent; /* Default transparent border */
            position: relative;
        }

        .tapering-option-box:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }

        /* Style for when the radio button inside is checked */
        .tapering-option-box input[type="radio"]:checked {
            border-color: var(--button-selected-bg);
            background-color: var(--button-selected-bg);
            box-shadow: 0 0 8px var(--button-selected-bg);
        }
        /* Ensure text color for selected radio option */
        .tapering-option-box input[type="radio"]:checked + span.text-general,
        .tapering-option-box input[type="radio"]:checked + span.text-general + span.text-label-small {
            color: var(--text-button-on-blue);
        }
        .tapering-option-box .text-label-small {
            font-size: 0.7rem;
            color: var(--text-label);
        }
        .tapering-option-box .text-general {
            font-family: 'Whitney Medium', sans-serif;
            font-size: 1rem;
            color: var(--text-general);
        }
        /* Flexbox for radio options */
        .tapering-options-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns */
            gap: 0.5rem;
        }

        /* Redemption option box styles */
        .redemption-option-box {
            background-color: var(--button-default-bg);
            color: var(--text-button-on-blue);
            font-family: 'Whitney Medium', sans-serif;
            font-size: 0.9rem;
            border-radius: 0.5rem;
            padding: 0.75rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, border-color 0.2s ease-in-out;
            border: 2px solid transparent; /* Default transparent border */
            position: relative;
        }

        .redemption-option-box:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }

        .redemption-option-box input[type="radio"]:checked {
            border-color: var(--button-selected-bg);
            background-color: var(--button-selected-bg);
            box-shadow: 0 0 8px var(--button-selected-bg);
        }
        .redemption-option-box input[type="radio"]:checked + span.text-general,
        .redemption-option-box input[type="radio"]:checked + span.text-general + span.text-label-small {
            color: var(--text-button-on-blue);
        }
        .redemption-option-box .text-label-small {
            font-size: 0.7rem;
            color: var(--text-label);
        }
        .redemption-option-box .text-general {
            font-family: 'Whitney Medium', sans-serif;
            font-size: 1rem;
            color: var(--text-general);
        }
        .redemption-options-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns */
            gap: 0.5rem;
        }

    </style>
</head>
<body>

    <div class="dashboard-container">
        <main class="w-full card-bg flex flex-col flex-grow">
            <div class="flex justify-between items-center mb-4">
                <h1 style="color: var(--text-heading); font-size: 28pt;" class="text-center w-full">Investeringsprognose</h1>
            </div>

            <div class="flex-grow relative" style="height: 400px;"> <canvas id="investmentChart"></canvas>
            </div>
            <div id="legend-container" class="flex justify-center flex-wrap gap-x-6 gap-y-2 mt-4" style="color: var(--text-general);"></div>
        </main>

        <!-- Ny seksjon for Aksjeandel over tid -->
        <section class="w-full card-bg flex flex-col mt-4" style="height: 250px;">
            <div class="flex justify-between items-center mb-4">
                <h2 style="font-size: 20pt; color: var(--text-heading);">Aksjeandel over tid</h2>
            </div>
            <div class="flex-grow relative"> <canvas id="allocationChart"></canvas></div>
        </section>

        <div class="w-full grid-container">
            <aside class="w-full card-bg">
                <h2 style="font-size: 20pt; color: var(--text-heading);" class="mb-6">Forutsetninger</h2>
                <div class="space-y-6">
                    <div>
                        <label for="initialPortfolioSize">Porteføljestørrelse (NOK)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="initialPortfolioSize" min="2500000" max="100000000" step="500000" value="10000000" class="w-full mt-1">
                            <span class="value-display" id="initialPortfolioSizeValue"></span>
                        </div>
                    </div>
                    <div>
                        <label for="investedCapital">Innskutt kapital (skattefri) (NOK)</label>
                           <div class="flex items-center gap-2">
                            <input type="range" id="investedCapital" min="0" max="50000000" step="100000" value="5000000" class="w-full mt-1">
                            <span class="value-display" id="investedCapitalValue"></span>
                        </div>
                    </div>
                    <div>
                        <label for="investmentYears">Antall år investeringsperiode (<span id="investmentYearsLabel">10</span>)</label>
                        <input type="range" id="investmentYears" min="1" max="30" value="10" class="w-full mt-1">
                    </div>
                    <div>
                        <label for="payoutYears">Antall år med utbetaling (<span id="payoutYearsLabel">10</span>)</label>
                        <input type="range" id="payoutYears" min="0" max="30" value="10" class="w-full mt-1">
                    </div>
                    <div>
                        <label for="desiredAnnualPayoutAfterTax">Ønsket årlig utbetaling (etter skatt) (NOK)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="desiredAnnualPayoutAfterTax" min="0" max="3000000" step="50000" value="1000000" class="w-full mt-1">
                            <span class="value-display" id="desiredAnnualPayoutAfterTaxValue"></span>
                        </div>
                    </div>
                </div>
            </aside>

            <footer class="w-full card-bg">
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size: 20pt; color: var(--text-heading);">Hendelser</h2>
                    <button id="add-event-btn" class="add-event-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Legg til hendelse</span>
                    </button>
                </div>
                <div class="space-y-6">
                    <div class="radio-group-container space-y-2">
                        <label class="text-label" style="font-size: 1rem;">Aksjeandel nedtrapping</label>
                        <div class="tapering-options-group">
                            <label for="tapering-none" class="tapering-option-box">
                                <input type="radio" id="tapering-none" name="taperingOption" value="none" checked class="hidden">
                                <span class="text-general">Ingen nedtrapping</span>
                                <span class="text-label-small">(Standard)</span>
                            </label>
                            <label for="tapering-5" class="tapering-option-box">
                                <input type="radio" id="tapering-5" name="taperingOption" value="5%" class="hidden">
                                <span class="text-general">5% nedtrapping</span>
                                <span class="text-label-small">per år</span>
                            </label>
                            <label for="tapering-10" class="tapering-option-box">
                                <input type="radio" id="tapering-10" name="taperingOption" value="10%" class="hidden">
                                <span class="text-general">10% nedtrapping</span>
                                <span class="text-label-small">per år</span>
                            </label>
                            <label for="tapering-15" class="tapering-option-box">
                                <input type="radio" id="tapering-15" name="taperingOption" value="15%" class="hidden">
                                <span class="text-general">15% nedtrapping</span>
                                <span class="text-label-small">per år</span>
                            </label>
                        </div>
                    </div>
                    <!-- Fjernet: Innløse hele porteføljen siste år -->
                    <div>
                        <label>Aksjeandel første år (%)</label>
                        <div class="stock-allocation-button-group">
                            <button class="stock-allocation-button" data-value="0">100% Renter</button>
                            <button class="stock-allocation-button" data-value="20">20% Aksjer</button>
                            <button class="stock-allocation-button" data-value="45">45% Aksjer</button>
                            <button class="stock-allocation-button" data-value="55">55% Aksjer</button>
                            <button class="stock-allocation-button" data-value="65">65% Aksjer</button>
                            <button class="stock-allocation-button" data-value="85">85% Aksjer</button>
                            <button class="stock-allocation-button" data-value="100">100% Aksjer</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="stockReturnRate">Forventet avkastning aksjer</label>
                        <div class="flex items-center gap-2 w-28">
                            <input type="range" id="stockReturnRate" value="8.0" min="5" max="10" step="0.1" class="w-full text-right px-2 py-1 bg-transparent border rounded-md">
                            <span class="value-display" id="stockReturnRateValue">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="bondReturnRate">Forventet avkastning renter</label>
                        <div class="flex items-center gap-2 w-28">
                            <input type="range" id="bondReturnRate" value="5.0" min="4" max="8" step="0.1" class="w-full text-right px-2 py-1 bg-transparent border rounded-md">
                            <span class="value-display" id="bondReturnRateValue">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="taxRate">Skattesats på uttak (etter innskutt kapital)</label>
                        <div class="flex items-center gap-2 w-28">
                            <input type="number" id="taxRate" value="37.8" step="0.1" disabled class="w-full text-right px-2 py-1 bg-transparent border rounded-md opacity-50 cursor-not-allowed">
                            <span class="value-display" id="taxRateValue">%</span>
                        </div>
                    </div>
                    <div>
                        <label for="annualSavings">Årlig sparing (NOK)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="annualSavings" min="0" max="1000000" step="10000" value="0" class="w-full mt-1">
                            <span class="value-display" id="annualSavingsValue"></span>
                        </div>
                    </div>
                    <div id="events-container" class="space-y-3">
                        </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {

        const App = {
            // Definerer startåret for simuleringen
            START_YEAR: new Date().getFullYear(), 
            
            // Applikasjonens tilstand, med standardverdier
            state: {
                initialPortfolioSize: 10000000, 
                investedCapital: 5000000,   
                investmentYears: 10,        
                payoutYears: 10,            
                desiredAnnualPayoutAfterTax: 1000000,
                initialStockAllocation: 80,  
                stockReturnRate: 8.0,       
                bondReturnRate: 5.0,        
                taxRate: 37.8,              
                annualStockPercentages: [], 
                annualSavings: 0,           
                events: [],                 
                taperingOption: 'none',     
                redeemPortfolioOption: 'none' 
            },
            
            // Fargepalett for diagrammet
            colors: {
                hovedstol: '#4ADE80', 
                avkastning: '#93C5FD', 
                sparing: '#3B82F6', 
                utbetaling_netto: '#9CA3AF', 
                utbetaling_skatt: '#CD5C5C', 
                event_uttak: '#FF6347', 
                event_innskudd: '#ADD8E6',
                // Nye farger for arealdiagram
                aksjeandel: '#81C784', 
                renteandel: '#64B5F6'  
            },
            
            // Data for diagramlegenden
            legendData: [
                { label: 'Hovedstol', color: '#4ADE80' },
                { label: 'Avkastning', color: '#93C5FD' },
                { label: 'Årlig sparing', color: '#3B82F6' },
                { label: 'Innskudd fra hendelser', color: '#ADD8E6' }, 
                { label: 'Netto utbetaling', color: '#9CA3AF' },
                { label: 'Skatt', color: '#DC143C' },
                { label: 'Uttak fra hendelser', color: '#FF6347' } 
            ],
            
            // Referanser til DOM-elementer
            elements: {},
            
            // Chart.js instans
            investmentChart: null,
            allocationChart: null, 

            // Funksjon for å formatere verdier som vises ved siden av slidere
            formatDisplayValue: function(id, value) {
                switch(id) {
                    case 'initialPortfolioSize':
                    case 'investedCapital':
                    case 'desiredAnnualPayoutAfterTax':
                    case 'annualSavings':
                        return this.formatCurrency(value);
                    case 'initialStockAllocation':
                        return `${value.toFixed(0)}%`; 
                    case 'stockReturnRate':
                    case 'bondReturnRate':
                    case 'taxRate':
                        return `${value.toFixed(value % 1 === 0 ? 0 : 1)}%`; 
                    case 'investmentYears':
                    case 'payoutYears':
                        return `${value} år`;
                    default:
                        return value;
                }
            },

            // Initialiserer applikasjonen
            init: function() {
                // Henter referanser til alle nødvendige DOM-elementer
                this.elements = {
                    initialPortfolioSize: document.getElementById('initialPortfolioSize'),
                    initialPortfolioSizeValue: document.getElementById('initialPortfolioSizeValue'), 
                    investedCapital: document.getElementById('investedCapital'),
                    investedCapitalValue: document.getElementById('investedCapitalValue'), 
                    investmentYears: document.getElementById('investmentYears'),
                    investmentYearsLabel: document.getElementById('investmentYearsLabel'),
                    payoutYears: document.getElementById('payoutYears'),
                    payoutYearsLabel: document.getElementById('payoutYearsLabel'),
                    desiredAnnualPayoutAfterTax: document.getElementById('desiredAnnualPayoutAfterTax'),
                    desiredAnnualPayoutAfterTaxValue: document.getElementById('desiredAnnualPayoutAfterTaxValue'), 
                    
                    stockReturnRate: document.getElementById('stockReturnRate'),
                    stockReturnRateValue: document.getElementById('stockReturnRateValue'), 
                    bondReturnRate: document.getElementById('bondReturnRate'),
                    bondReturnRateValue: document.getElementById('bondReturnRateValue'), 
                    taxRate: document.getElementById('taxRate'),
                    taxRateValue: document.getElementById('taxRateValue'), 
                    legendContainer: document.getElementById('legend-container'),
                    annualSavings: document.getElementById('annualSavings'), 
                    annualSavingsValue: document.getElementById('annualSavingsValue'), 
                    addEventBtn: document.getElementById('add-event-btn'),
                    eventsContainer: document.getElementById('events-container'),
                    
                    taperingOptionRadios: document.querySelectorAll('input[name="taperingOption"]'), 
                    stockAllocationButtons: document.querySelectorAll('.stock-allocation-button'), 
                };

                // Setter opp Chart.js diagrammet (Hovedprognose)
                const ctxInvestment = document.getElementById('investmentChart').getContext('2d');
                this.investmentChart = new Chart(ctxInvestment, {
                    type: 'bar', 
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true, 
                                grid: { display: false },
                                ticks: {
                                    color: '#FFFFFF', 
                                    font: {
                                        size: 12,
                                        family: 'Whitney Light, sans-serif',
                                        weight: 'normal'
                                    }
                                },
                                barPercentage: 0.9,
                                categoryPercentage: 0.8,
                            },
                            y: {
                                stacked: true, 
                                beginAtZero: false,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                                ticks: {
                                    color: '#FFFFFF' , 
                                    font: {
                                        size: 12,
                                        family: 'Whitney Light, sans-serif',
                                        weight: 'normal'
                                    },
                                    callback: (value) => {
                                        if (value < 0) { 
                                            if (Math.abs(value) % 2000000 === 0) { 
                                                return (value / 1000000).toLocaleString('no-NO', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' MNOK';
                                            }
                                            return ''; 
                                        } else { 
                                            if (value % 5000000 === 0) {
                                                return (value / 1000000).toLocaleString('no-NO', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' MNOK';
                                            }
                                            return ''; 
                                        }
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }, 
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: (tooltipItems) => `År ${tooltipItems[0].label}`,
                                    label: (context) => {
                                        const label = context.dataset.label || '';
                                        let value = context.raw;
                                        const formattedValue = value < 0 ? 
                                            `-${Math.abs(value).toLocaleString('no-NO', { style: 'currency', currency: 'NOK', minimumFractionDigits: 0 })}` :
                                            value.toLocaleString('no-NO', { style: 'currency', currency: 'NOK', minimumFractionDigits: 0 });
                                        return `${label}: ${formattedValue}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
                
                // Setter opp Chart.js diagrammet (Arealdiagram for fordeling)
                const ctxAllocation = document.getElementById('allocationChart').getContext('2d');
                this.allocationChart = new Chart(ctxAllocation, {
                    type: 'line', // For arealdiagram
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Aksjeandel over tid', // Endret tittel her
                                color: '#FFFFFF',
                                font: {
                                    size: 16,
                                    family: 'Whitney Bold, sans-serif'
                                }
                            },
                            legend: {
                                display: true, // Vis legende for dette diagrammet
                                labels: {
                                    color: '#FFFFFF',
                                    font: {
                                        size: 14,
                                        family: 'Whitney Light, sans-serif'
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: (tooltipItems) => `År ${tooltipItems[0].label}`,
                                    label: (context) => {
                                        const label = context.dataset.label || '';
                                        const value = context.raw;
                                        return `${label}: ${value.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true, // Viktig for arealdiagram (100% stablet)
                                grid: { display: false },
                                ticks: {
                                    color: '#FFFFFF',
                                    font: {
                                        size: 12,
                                        family: 'Whitney Light, sans-serif'
                                    }
                                }
                            },
                            y: {
                                stacked: true, // Viktig for arealdiagram (100% stablet)
                                beginAtZero: true,
                                max: 100, // Prosent
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: {
                                    color: '#FFFFFF',
                                    font: {
                                        size: 12,
                                        family: 'Whitney Light, sans-serif'
                                    },
                                    callback: (value) => `${value}%`
                                }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        elements: {
                            line: {
                                tension: 0.4 // Smooth linjer for arealdiagram
                            }
                        }
                    }
                });


                const sliderInputs = [
                    this.elements.initialPortfolioSize, this.elements.investedCapital, 
                    this.elements.investmentYears, this.elements.payoutYears, 
                    this.elements.desiredAnnualPayoutAfterTax, 
                    this.elements.stockReturnRate, this.elements.bondReturnRate, 
                    this.elements.annualSavings 
                ];

                sliderInputs.forEach(input => {
                    input.addEventListener('input', this.handleSliderChange.bind(this));
                });

                // Apply initial validation for investedCapital based on initialPortfolioSize
                this.elements.investedCapital.max = this.elements.initialPortfolioSize.value;
                if (parseFloat(this.elements.investedCapital.value) > parseFloat(this.elements.initialPortfolioSize.value)) {
                    this.elements.investedCapital.value = this.elements.initialPortfolioSize.value;
                    this.state.investedCapital = parseFloat(this.elements.initialPortfolioSize.value);
                }


                this.elements.stockAllocationButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const value = parseInt(e.target.dataset.value, 10);
                        this.state.initialStockAllocation = value;
                        this.updateUI(); 
                    });
                });

                this.elements.taperingOptionRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.state.taperingOption = e.target.value;
                        this.updateUI(); 
                    });
                });

                this.elements.addEventBtn.addEventListener('click', this.addEvent.bind(this));

                this.createLegend();
                this.populateAnnualStockPercentages(); 
                this.updateUI(); 
            },

            handleSliderChange: function(event) {
                const { id, value } = event.target;
                let parsedValue = parseFloat(value);
                this.state[id] = parsedValue;

                // Specific logic for investedCapital in relation to initialPortfolioSize
                if (id === 'initialPortfolioSize') {
                    // When initialPortfolioSize changes, update max for investedCapital
                    this.elements.investedCapital.max = parsedValue;
                    // If current investedCapital exceeds new initialPortfolioSize, adjust it
                    if (this.state.investedCapital > parsedValue) {
                        this.state.investedCapital = parsedValue;
                        this.elements.investedCapital.value = parsedValue;
                    }
                } else if (id === 'investedCapital') {
                    // When investedCapital changes, ensure it doesn't exceed initialPortfolioSize
                    const currentPortfolioSize = parseFloat(this.elements.initialPortfolioSize.value);
                    if (parsedValue > currentPortfolioSize) {
                        parsedValue = currentPortfolioSize;
                        this.state.investedCapital = parsedValue;
                        this.elements.investedCapital.value = parsedValue; // Update the slider's visual value
                    }
                }

                if (this.elements[`${id}Label`]) { 
                    this.elements[`${id}Label`].textContent = this.formatDisplayValue(id, parsedValue);
                } else if (this.elements[`${id}Value`]) { 
                    this.elements[`${id}Value`].textContent = this.formatDisplayValue(id, parsedValue);
                }
                
                this.updateUI();
            },

            formatCurrency: (value) => new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value),
            formatNumber: (value) => new Intl.NumberFormat('nb-NO').format(value),
            
            populateAnnualStockPercentages: function() {
                // The total simulated years should only be based on investmentYears and payoutYears
                // since the "redeemPortfolioOption" feature has been removed.
                const totalSimulatedYears = this.state.investmentYears + this.state.payoutYears;
                this.state.annualStockPercentages = [];

                for (let index = 0; index < totalSimulatedYears; index++) {
                    const isInvestmentYear = index < this.state.investmentYears; 
                    const isPayoutYear = index >= this.state.investmentYears;

                    let currentPercentage = 0; 

                    if (isInvestmentYear) {
                        currentPercentage = this.state.initialStockAllocation;
                    } else if (isPayoutYear) {
                        if (this.state.taperingOption !== 'none') {
                            const taperRate = parseFloat(this.state.taperingOption.replace('%', '')) / 100; 
                            const payoutYearIndex = index - this.state.investmentYears;

                            let basePercentageForTapering;
                            if (this.state.investmentYears > 0) {
                                basePercentageForTapering = this.state.annualStockPercentages[this.state.investmentYears - 1];
                            } else {
                                basePercentageForTapering = this.state.initialStockAllocation;
                            }

                            const reductionAmount = payoutYearIndex * (taperRate * 100); 
                            currentPercentage = Math.max(0, basePercentageForTapering - reductionAmount);

                        } else {
                            currentPercentage = this.state.initialStockAllocation;
                        }
                    }
                    this.state.annualStockPercentages.push(currentPercentage);
                }
            },

            addEvent: function() {
                const eventId = `event-${Date.now()}`;
                // totalSimulatedYears adjusted as redeemPortfolioOption is removed.
                const totalSimulatedYears = this.state.investmentYears + this.state.payoutYears;
                const maxYear = this.START_YEAR + totalSimulatedYears - 1;
                const defaultStartYear = Math.min(maxYear, this.START_YEAR + 5);
                const newEvent = { id: eventId, type: 'Uttak', belop: -100000, startAar: defaultStartYear, sluttAar: defaultStartYear };
                this.state.events.push(newEvent);

                const eventRow = document.createElement('div');
                eventRow.id = eventId;
                eventRow.className = 'event-row'; 
                eventRow.innerHTML = `
                    <div class="col-span-3">
                        <input type="text" value="Uttak" data-key="type" class="w-full px-3 py-2" placeholder="Navn på hendelse">
                    </div>
                    <div class="col-span-5 event-range-slider-container">
                        <div class="event-range-track"></div>
                        <div class="event-range-highlight"></div>
                        <input type="range" data-key="startAar" min="${this.START_YEAR}" max="${maxYear}" value="${newEvent.startAar}" class="event-range-slider-start">
                        <input type="range" data-key="sluttAar" min="${this.START_YEAR}" max="${maxYear}" value="${newEvent.sluttAar}" class="event-range-slider-end">
                        <div class="event-range-slider-labels">
                            <span class="start-year-label">${newEvent.startAar}</span>
                            <span class="end-year-label">${newEvent.sluttAar}</span>
                        </div>
                    </div>
                    <div class="col-span-3">
                        <input type="text" data-key="belop" value="${newEvent.belop}" inputmode="numeric" class="w-full px-3 py-2" placeholder="Beløp">
                    </div>
                    <div class="col-span-1 text-right">
                        <button class="remove-event-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                    </div>`;
                this.elements.eventsContainer.appendChild(eventRow);
                
                const amountInput = eventRow.querySelector('input[data-key="belop"]');
                // Set initial value correctly, handling -0 for display when adding new event
                amountInput.value = (newEvent.belop === -0 ? '-' : newEvent.belop).toLocaleString('nb-NO', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); 

                amountInput.addEventListener('input', (e) => { 
                    let rawValue = e.target.value.replace(/\s/g, '').replace(/,/g, '.');
                    let parsedValue;
                    
                    if (rawValue === '-' || rawValue === '') { 
                        // If only '-' or empty, set internal value to 0 or -0 for calculations
                        parsedValue = (rawValue === '-') ? -0 : 0; 
                    } else {
                        parsedValue = parseFloat(rawValue);
                        if (isNaN(parsedValue)) {
                            parsedValue = 0; // If not a valid number, treat as 0 for calculations
                        }
                    }
                    
                    newEvent.belop = parsedValue; 
                    // Do NOT modify e.target.value here. Let the user type freely.
                    // The visual update will happen on blur or via full UI recalculation.
                    this.updateUI(); 
                });

                amountInput.addEventListener('blur', (e) => { 
                    let rawValue = e.target.value.replace(/\s/g, '').replace(/,/g, '.');
                    let value = parseFloat(rawValue);
                    
                    // If input is empty, just '-', or invalid, set value to 0 for consistency
                    if (isNaN(value) || rawValue === '' || rawValue === '-') { 
                        value = 0;
                    }
                    
                    // Update the input field's display with formatted value
                    e.target.value = value.toLocaleString('nb-NO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    newEvent.belop = value; // Ensure the event object holds the final, clean numerical value
                    
                    this.updateUI(); 
                });


                const updateRangeHighlight = () => {
                    const startSlider = eventRow.querySelector('.event-range-slider-start');
                    const endSlider = eventRow.querySelector('.event-range-slider-end');
                    const highlight = eventRow.querySelector('.event-range-highlight');
                    const min = parseInt(startSlider.min, 10); const max = parseInt(startSlider.max, 10);
                    const range = max - min;
                    if (range === 0) { highlight.style.width = '0%'; return; };
                    const left = (parseInt(startSlider.value, 10) - min) / range * 100;
                    const width = (parseInt(endSlider.value, 10) - parseInt(startSlider.value, 10)) / range * 100;
                    highlight.style.left = `${left}%`;
                    highlight.style.width = `${Math.max(0, width)}%`;
                };

                eventRow.addEventListener('input', (e) => {
                    const event = this.state.events.find(ev => ev.id === eventId);
                    const key = e.target.dataset.key;
                    if (key === 'belop') return; 

                    let value = e.target.type === 'number' || e.target.type === 'range' ? parseFloat(e.target.value) : e.target.value;
                    
                    event[key] = value;
                    if (key === 'startAar' || key === 'sluttAar') {
                        const startSlider = eventRow.querySelector('.event-range-slider-start');
                        const endSlider = eventRow.querySelector('.event-range-slider-end');
                        if (parseFloat(startSlider.value) > parseFloat(endSlider.value)) {
                            if (key === 'startAar') endSlider.value = startSlider.value; else startSlider.value = endSlider.value;
                        }
                        event.startAar = parseFloat(startSlider.value);
                        event.sluttAar = parseFloat(endSlider.value);
                        eventRow.querySelector('.start-year-label').textContent = event.startAar;
                        eventRow.querySelector('.end-year-label').textContent = event.sluttAar;
                        updateRangeHighlight();
                    }
                    this.updateUI();
                });

                eventRow.querySelector('.remove-event-button').addEventListener('click', () => {
                    this.state.events = this.state.events.filter(ev => ev.id !== eventId);
                    eventRow.remove();
                    this.updateUI();
                });
                updateRangeHighlight();
                this.updateUI();
            },

            calculatePrognosis: function() {
                const labels = [];
                const data = { 
                    hovedstol: [], 
                    avkastning: [], 
                    sparing: [], 
                    nettoUtbetaling: [], 
                    skatt: [],            
                    eventUttak: [],       
                    eventInnskudd: [],
                    annualStockPercentages: [], 
                    annualBondPercentages: []   
                };

                let currentPortfolioValue = this.state.initialPortfolioSize;
                let taxFreeCapitalRemaining = this.state.investedCapital; 

                const stockReturnRate = this.state.stockReturnRate / 100;
                const bondReturnRate = this.state.bondReturnRate / 100;
                const taxRate = this.state.taxRate / 100;
                const desiredAnnualPayoutAfterTax = this.state.desiredAnnualPayoutAfterTax;
                const annualSavings = this.state.annualSavings;

                let totalSimulatedYears = this.state.investmentYears + this.state.payoutYears;
                const lastOrdinaryPayoutYearIndex = this.state.investmentYears + this.state.payoutYears - 1; 

                for (let i = 0; i < totalSimulatedYears; i++) {
                    const year = this.START_YEAR + i;
                    labels.push(year.toString());

                    let startOfYearPortfolioValue = currentPortfolioValue; 

                    let annualNetWithdrawalAmountForChart = 0; 
                    let annualTaxAmount = 0;           
                    let annualEventGrossWithdrawalForChart = 0; 
                    let annualEventContributionForChart = 0;    

                    console.group(`--- År ${year} ---`);
                    console.log(`Porteføljeverdi ved start: ${this.formatCurrency(currentPortfolioValue)}`);
                    console.log(`Skattefri kapital gjenstående ved start: ${this.formatCurrency(taxFreeCapitalRemaining)}`);


                    // --- Trinn 1: Håndter årlig sparing og hendelsesinnskudd (Positive) ---
                    let currentYearTotalInflow = annualSavings;
                    this.state.events.forEach(event => {
                        if (year >= event.startAar && year <= event.sluttAar && event.belop > 0) {
                            currentYearTotalInflow += event.belop;
                            annualEventContributionForChart += event.belop;
                        }
                    });

                    currentPortfolioValue += currentYearTotalInflow;
                    taxFreeCapitalRemaining += currentYearTotalInflow;
                    console.log(`+ Inflow (sparing + positive hendelser): ${this.formatCurrency(currentYearTotalInflow)}`);
                    console.log(`Ny porteføljeverdi etter innskudd: ${this.formatCurrency(currentPortfolioValue)}`);
                    console.log(`Ny skattefri kapital etter innskudd: ${this.formatCurrency(taxFreeCapitalRemaining)}`);


                    // --- Trinn 2: Beregn investeringsavkastning ---
                    const annualStockPercentage = this.state.annualStockPercentages[i]; 
                    const annualBondPercentage = 100 - annualStockPercentage; 
                    const effectiveReturnRate = ((annualStockPercentage / 100) * stockReturnRate) + ((annualBondPercentage / 100) * bondReturnRate);
                    const grossReturn = currentPortfolioValue * effectiveReturnRate;
                    currentPortfolioValue += grossReturn;
                    console.log(`+ Avkastning: ${this.formatCurrency(grossReturn)}`);
                    console.log(`Porteføljeverdi etter avkastning: ${this.formatCurrency(currentPortfolioValue)}`);


                    // --- Trinn 3: Håndter hendelsesuttak (Negative) ---
                    let currentYearEventWithdrawalsNegative = 0;
                    this.state.events.forEach(event => {
                        if (year >= event.startAar && year <= event.sluttAar && event.belop < 0) {
                            currentYearEventWithdrawalsNegative += event.belop;
                        }
                    });

                    if (currentYearEventWithdrawalsNegative < 0) {
                        let amountToWithdraw = Math.abs(currentYearEventWithdrawalsNegative);
                        annualEventGrossWithdrawalForChart += amountToWithdraw; 

                        console.log(`- Hendelsesuttak (brutto): ${this.formatCurrency(amountToWithdraw)}`);

                        // Først, tømme taxFreeCapitalRemaining
                        let fromTaxFree = Math.min(amountToWithdraw, taxFreeCapitalRemaining);
                        taxFreeCapitalRemaining -= fromTaxFree;
                        currentPortfolioValue -= fromTaxFree; 
                        
                        let remainingAmountToWithdraw = amountToWithdraw - fromTaxFree;
                        
                        // Hvis det er et gjenværende beløp å ta ut, er det skattepliktig fra porteføljen
                        if (remainingAmountToWithdraw > 0 && currentPortfolioValue > 0) {
                            let taxableAmount = Math.min(remainingAmountToWithdraw, currentPortfolioValue);
                            let taxForEvent = taxableAmount * taxRate;

                            annualTaxAmount += taxForEvent; 
                            currentPortfolioValue -= taxableAmount; 

                            console.log(`  -> Fra skattefri (hendelse): ${this.formatCurrency(fromTaxFree)}`);
                            console.log(`  -> Skattepliktig uttak fra hendelse: ${this.formatCurrency(taxableAmount)}`);
                            console.log(`  -> Skatt på hendelse: ${this.formatCurrency(taxForEvent)}`);
                        } else if (remainingAmountToWithdraw > 0 && currentPortfolioValue <= 0) {
                            console.log(`  -> Kunne ikke ta ut resterende beløp (${this.formatCurrency(remainingAmountToWithdraw)}) da porteføljen er tom.`);
                        }
                        console.log(`  Gjenstående porteføljeverdi etter hendelsesuttak: ${this.formatCurrency(currentPortfolioValue)}`);
                        console.log(`  Gjenstående skattefri kapital etter hendelsesuttak: ${this.formatCurrency(taxFreeCapitalRemaining)}`);
                    }

                    // --- Trinn 4: Håndter ønskede årlige utbetalinger ---
                    const isOrdinaryPayoutYear = (i >= this.state.investmentYears && i <= lastOrdinaryPayoutYearIndex); 

                    if (isOrdinaryPayoutYear) { 
                        let desiredNet = desiredAnnualPayoutAfterTax;
                        console.log(`- Ønsket årlig utbetaling (netto): ${this.formatCurrency(desiredNet)}`);
                        
                        // Først, tømme taxFreeCapitalRemaining for ønsket utbetaling
                        let fromTaxFree = Math.min(desiredNet, taxFreeCapitalRemaining);
                        taxFreeCapitalRemaining -= fromTaxFree;
                        currentPortfolioValue -= fromTaxFree; 
                        annualNetWithdrawalAmountForChart += fromTaxFree; 
                        console.log(`  -> Fra skattefri (utbetaling): ${this.formatCurrency(fromTaxFree)}`);

                        let remainingDesiredNet = desiredNet - fromTaxFree;

                        // Hvis det er mer som trengs, er det skattepliktig
                        if (remainingDesiredNet > 0 && currentPortfolioValue > 0) {
                            let grossNeededFromTaxable = remainingDesiredNet / (1 - taxRate);
                            let taxableAmount = Math.min(grossNeededFromTaxable, currentPortfolioValue); 
                            
                            let taxForPension = taxableAmount * taxRate;
                            let netAfterTaxForPension = taxableAmount - taxForPension;

                            annualTaxAmount += taxForPension;
                            annualNetWithdrawalAmountForChart += netAfterTaxForPension; 
                            currentPortfolioValue -= taxableAmount; 

                            console.log(`  -> Skattepliktig uttak: ${this.formatCurrency(taxableAmount)}`);
                            console.log(`  -> Skatt på utbetaling: ${this.formatCurrency(taxForPension)}`);
                            console.log(`  -> Netto etter skatt: ${this.formatCurrency(netAfterTaxForPension)}`);
                        } else if (remainingDesiredNet > 0 && currentPortfolioValue <= 0) {
                            console.log(`  -> Kunne ikke ta ut resterende ønsket netto beløp (${this.formatCurrency(remainingDesiredNet)}) da porteføljen er tom.`);
                        }
                        console.log(`  Gjenstående porteføljeverdi etter årlig utbetaling: ${this.formatCurrency(currentPortfolioValue)}`);
                        console.log(`  Gjenstående skattefri kapital etter årlig utbetaling: ${this.formatCurrency(taxFreeCapitalRemaining)}`);
                    }
                    
                    // Forsikre at porteføljeverdi og skattefri kapital ikke går under null
                    currentPortfolioValue = Math.max(0, currentPortfolioValue);
                    taxFreeCapitalRemaining = Math.max(0, taxFreeCapitalRemaining);

                    console.log(`Porteføljeverdi ved slutten av året: ${this.formatCurrency(currentPortfolioValue)}`);
                    console.log(`Skattefri kapital gjenstående ved slutten av året: ${this.formatCurrency(taxFreeCapitalRemaining)}`);
                    console.log(`Total netto uttak dette året (for diagram): ${this.formatCurrency(annualNetWithdrawalAmountForChart)}`);
                    console.log(`Total skatt dette året: ${this.formatCurrency(annualTaxAmount)}`);

                    // Legg til data for diagram (negativt for utgående strømmer)
                    data.hovedstol.push(Math.round(startOfYearPortfolioValue));
                    data.avkastning.push(Math.round(grossReturn));
                    data.sparing.push(Math.round(annualSavings)); 
                    data.eventInnskudd.push(Math.round(annualEventContributionForChart)); 
                    data.nettoUtbetaling.push(Math.round(-annualNetWithdrawalAmountForChart)); 
                    data.skatt.push(Math.round(-annualTaxAmount)); 
                    data.eventUttak.push(Math.round(-annualEventGrossWithdrawalForChart)); 
                    
                    // Push data for det nye arealdiagrammet
                    data.annualStockPercentages.push(Math.round(annualStockPercentage));
                    data.annualBondPercentages.push(Math.round(annualBondPercentage));
                    console.groupEnd();
                }

                return { labels, data };
            },

            updateUI: function() {
                if (!this.investmentChart || !this.allocationChart) return;

                this.populateAnnualStockPercentages(); 

                const { labels, data } = this.calculatePrognosis();
                this.investmentChart.data.labels = labels;
                this.allocationChart.data.labels = labels; 

                this.investmentChart.data.datasets = [
                    {
                        label: 'Avkastning', 
                        data: data.avkastning,
                        backgroundColor: this.colors.avkastning,
                        stack: 'portfolio',
                    },
                    {
                        label: 'Årlig sparing', 
                        data: data.sparing,
                        backgroundColor: this.colors.sparing,
                        stack: 'portfolio',
                    },
                     {
                        label: 'Innskudd fra hendelser', 
                        data: data.eventInnskudd,
                        backgroundColor: this.colors.event_innskudd, 
                        stack: 'portfolio',
                    },
                    {
                        label: 'Hovedstol', 
                        data: data.hovedstol,
                        backgroundColor: this.colors.hovedstol,
                        stack: 'portfolio',
                    },
                    {
                        label: 'Netto utbetaling', 
                        data: data.nettoUtbetaling,
                        backgroundColor: this.colors.utbetaling_netto,
                        stack: 'portfolio', 
                    },
                    {
                        label: 'Skatt', 
                        data: data.skatt,
                        backgroundColor: this.colors.utbetaling_skatt,
                        stack: 'portfolio', 
                    },
                    {
                        label: 'Uttak fra hendelser', 
                        data: data.eventUttak,
                        backgroundColor: this.colors.event_uttak,
                        stack: 'portfolio', 
                    }
                ];
                
                this.allocationChart.data.datasets = [
                    {
                        label: 'Aksjeandel',
                        data: data.annualStockPercentages,
                        backgroundColor: this.colors.aksjeandel,
                        borderColor: this.colors.aksjeandel,
                        fill: true,
                        stack: 'allocation', 
                        tension: 0.4
                    },
                    {
                        label: 'Renteandel',
                        data: data.annualBondPercentages,
                        backgroundColor: this.colors.renteandel,
                        borderColor: this.colors.renteandel,
                        fill: true,
                        stack: 'allocation', 
                        tension: 0.4
                    }
                ];

                this.investmentChart.update(); 
                this.allocationChart.update(); 

                this.elements.initialPortfolioSizeValue.textContent = this.formatDisplayValue('initialPortfolioSize', this.state.initialPortfolioSize);
                this.elements.investedCapitalValue.textContent = this.formatDisplayValue('investedCapital', this.state.investedCapital);
                this.elements.desiredAnnualPayoutAfterTaxValue.textContent = this.formatDisplayValue('desiredAnnualPayoutAfterTax', this.state.desiredAnnualPayoutAfterTax);
                this.elements.stockReturnRateValue.textContent = this.formatDisplayValue('stockReturnRate', this.state.stockReturnRate);
                this.elements.bondReturnRateValue.textContent = this.formatDisplayValue('bondReturnRate', this.state.bondReturnRate);
                this.elements.taxRateValue.textContent = this.formatDisplayValue('taxRate', this.state.taxRate);
                this.elements.annualSavingsValue.textContent = this.formatDisplayValue('annualSavings', this.state.annualSavings);

                this.elements.investmentYearsLabel.textContent = this.formatDisplayValue('investmentYears', this.state.investmentYears);
                this.elements.payoutYearsLabel.textContent = this.formatDisplayValue('payoutYears', this.state.payoutYears);

                this.elements.stockAllocationButtons.forEach(button => {
                    if (parseInt(button.dataset.value, 10) === this.state.initialStockAllocation) {
                        button.classList.add('selected');
                    } else {
                        button.classList.remove('selected');
                    }
                });
            },

            createLegend: function() {
                this.elements.legendContainer.innerHTML = '';
                const fullLegendData = [
                    { label: 'Hovedstol', color: this.colors.hovedstol },
                    { label: 'Avkastning', color: this.colors.avkastning },
                    { label: 'Årlig sparing', color: this.colors.sparing },
                    { label: 'Innskudd fra hendelser', color: this.colors.event_innskudd }, 
                    { label: 'Netto utbetaling', color: this.colors.utbetaling_netto },
                    { label: 'Skatt', color: this.colors.utbetaling_skatt },
                    { label: 'Uttak fra hendelser', color: this.colors.event_uttak } 
                ];

                fullLegendData.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    legendItem.innerHTML = `<div class="w-4 h-4 rounded-sm mr-2" style="background-color: ${item.color}"></div><span>${item.label}</span>`;
                    this.elements.legendContainer.appendChild(legendItem);
                });
            },
        };

        App.init();
    });
    </script>
</body>
</html>
